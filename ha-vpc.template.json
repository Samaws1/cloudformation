{
  "AWSTemplateFormatVersion":"2010-09-09",
  
  "Description": "This Caylent template creates an HA-ready VPC and includes 4 subnets, a public route table, internet gateway, and attachments between them all. It is compatible with Caylent stacks and lets you deploy high-availability infrastructure into this VPC.",
  
  "Parameters": {
    "Environment": {
      "Description": "The name of the environment for this stack",
      "Type": "String",
      "Default": "production",
      "AllowedValues": ["production", "staging", "development" ],
      "ConstraintDescription": "must be one of production, staging or development"
   },
   
  "VPC": {
    "Description": "The name of the VPC",
    "Type": "String",
    "MinLength": "1",
    "MaxLength": "128"
  },
    
  "Resources": {
    "VPC": {
      "Type":"AWS::EC2::VPC",
      "Properties": {
          "EnableDnsSupport": "true",
          "EnableDnsHostnames": "true",
          "CidrBlock": "10.0.0.0\/16",
          "Tags":[
            {
              "Key": "Name",
              "Value": "VPC"
            },
            {
              "Key": "caylent-id",
              "Value": "Environment"
            }
          ]
        },

    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": "main-gateway"
          },
          {
            "Key": "Network",
            "Value": "Public"
          }
        ]
      }
    },
    
    "GatewayToInternet": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "InternetGatewayId": {
          "Ref": "InternetGateway" 
        }
      }
    },
    
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "public-route"
          },
          {
            "Key": "Network",
            "Value": "Public"
          }
        ]
      }
    },
    
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "GatewayToInternet",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0\/0",
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    
    "SubnetRouteTableAssociation1": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PublicSubnet1" },
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      }
    },

    "SubnetRouteTableAssociation2": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PublicSubnet2"},
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      }
    },
    
    "PublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": "us-east-1a",
        "MapPublicIpOnLaunch": true,
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.1.0\/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "Subnet-1"
          },
          {
            "Key": "caylent-id",
            "Value": "Environment"
          },
          {
            "Key": "Network",
            "Value": "Public"
          }
        ]
      }
    },

    "PublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": "us-east-1b",
        "MapPublicIpOnLaunch": true,
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.2.0\/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "Subnet-2"
          },
          {
            "Key": "caylent-id",
            "Value": "Environment"
          },
          {
            "Key": "Network",
            "Value": "Public"
          }
        ]
      }
    },

    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": "us-east-1a",
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.3.0\/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "Subnet-3"
          },
          {
            "Key": "caylent-id",
            "Value": "Environment"
          },
          {
            "Key": "Network",
            "Value": "Private"
          }
        ]
      }
    },
    
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": "us-east-1b",
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.4.0\/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "Subnet-4"
          },
          {
            "Key": "caylent-id",
            "Value": "Environment"
          },
          {
            "Key": "Network",
            "Value": "Private"
          }
        ]
      }
    }
  }
},
